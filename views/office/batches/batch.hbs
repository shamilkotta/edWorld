<div class="d-flex flex-wrap">
  {{> office/batches}}
  <div class="tab-bar mb-4 ms-2 mt-2">
    <div class="d-flex py-3 px-4 justify-content-center align-items-center">
      <a
        data-mdb-toggle="modal"
        data-mdb-target="#editBatch"
        class="d-flex flex-column justify-content-center align-items-center flex-sm-row"
        style="cursor: pointer;"
      >
        <img src="/static/icon/document-edit.svg" width="25px" alt="" />
        <span class="ms-2">Edit Batch Details</span>
      </a>
    </div>
  </div>
</div>

<section class="mt-5">
  <section>
    <div class="container-fluid">
      <div class="row gy-4">
        <div class="col-md-3 col-sm-6">
          <div class="card shadow mb-0">
            <div class="card-body">
              <div class="d-flex align-items-end justify-content-between mb-2">
                <div class="me-2">

                  <p class="text-sm text-uppercase text-gray-600 lh-1 mb-0">New
                    Clients</p>
                </div>
                <p class="fs-2 lh-1 mb-0 text-success">27</p>
              </div>
              <div class="progress" style="height: 3px">
                <div
                  class="progress-bar bg-success"
                  role="progressbar"
                  style="width: 30%"
                  aria-valuenow="30"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow mb-0">
            <div class="card-body">
              <div class="d-flex align-items-end justify-content-between mb-2">
                <div class="me-2">

                  <p class="text-sm text-uppercase text-gray-600 lh-1 mb-0">New
                    Projects</p>
                </div>
                <p class="fs-2 lh-1 mb-0 text-success">375</p>
              </div>
              <div class="progress" style="height: 3px">
                <div
                  class="progress-bar bg-success"
                  role="progressbar"
                  style="width: 70%"
                  aria-valuenow="70"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow mb-0">
            <div class="card-body">
              <div class="d-flex align-items-end justify-content-between mb-2">
                <div class="me-2">

                  <p class="text-sm text-uppercase text-gray-600 lh-1 mb-0">New
                    Invoices</p>
                </div>
                <p class="fs-2 lh-1 mb-0 text-success">140</p>
              </div>
              <div class="progress" style="height: 3px">
                <div
                  class="progress-bar bg-success"
                  role="progressbar"
                  style="width: 55%"
                  aria-valuenow="55"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow mb-0">
            <div class="card-body">
              <div class="d-flex align-items-end justify-content-between mb-2">
                <div class="me-2">

                  <p class="text-sm text-uppercase text-gray-600 lh-1 mb-0">All Projects</p>
                </div>
                <p class="fs-2 lh-1 mb-0 text-success">140</p>
              </div>
              <div class="progress" style="height: 3px">
                <div
                  class="progress-bar bg-success"
                  role="progressbar"
                  style="width: 55%"
                  aria-valuenow="55"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div
    class="d-flex flex-wrap align-items-center justify-content-evenly mt-4 shadow py-2"
    style="font-size: 18px; row-gap: 10px;"
  >
    <div class="mx-2">
      <span class="text-muted">Batch:</span>
      <span class="fw-bold" id="batch-code">{{batch.code}}</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">Start Date:</span>
      <span class="fw-bold">{{batch.start_date}}</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">Duration:</span>
      <span class="fw-bold">{{batch.duration}} months</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">End Date:</span>
      <span class="fw-bold">{{batch.end_date}}</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">Students:</span>
      <span class="fw-bold">{{batch.students}}</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">Seats:</span>
      <span class="fw-bold" id="seat-num">{{batch.seat_num}}</span>
    </div>
    <div style="color: #bbbbbb;">|</div>
    <div class="mx-2">
      <span class="text-muted">Batch Head: </span>
      {{#if batch.batch_head}}
        <span class="fw-bold" id="batch-head-name">{{batch.head}}</span>
        <span
          class="text-muted"
          style="font-size: 15px;"
          id="batch-head"
        >({{batch.batch_head}})</span>
        <a href="/office/teacher/{{batch.batch_head}}" class="mt-0">
          <img src="/static/icon/export.svg" width="15px" alt="{{batch.batch_head}}" />
        </a>
      {{else}}
        <span class="fw-bold" id="batch-head-name">-</span>
      {{/if}}
    </div>
  </div>

  <h6 class="mb-4 mt-5">All Students</h6>
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="batches-table">
      <thead class="bg-dark text-white">
        <tr>
          <th scope="col">Id</th>
          <th scope="col">Name</th>
          <th scope="col">Contact</th>
          <th scope="col">Batch</th>
          <th scope="col">Parent</th>
          <th scope="col">Education</th>
          <th scope="col">University</th>
          <th scope="col">View</th>
        </tr>
      </thead>
      <tbody>
        {{#each allStudents}}
          <tr>
            <td scope="row">{{this.registerId}}</td>
            <td class="d-flex align-items-center">
              <img
                src="{{this.profile}}"
                style="border-radius: 50%; border: 1px solid #3BB77E; padding: 1px"
                width="40px"
                height="40px"
                class="me-2"
                alt="{{this.name}}"
              />
              <div>
                <span class="fs-6 text-black fw-normal">{{this.name}}</span><br
                />
                <span
                  class="text-muted"
                  style="font-size: 13px;"
                >{{this.birth_date}}</span>
              </div>
            </td>
            <td>
              <a href="tel:{{this.phone}}" class="me-1">
                <img src="/static/icon/phone.svg" width="34px" alt="call" />
              </a>
              <a href="mailto:{{this.email}}">
                <img src="/static/icon/mail.svg" width="34px" alt="mail" />
              </a>
            </td>
            <td>{{this.batch}}</td>
            <td>{{this.parent_name}}</td>
            <td>{{this.education}}</td>
            <td>{{this.university}}</td>
            <td>
              <a href="/office/student/{{this.registerId}}">
                <img src="/static/icon/export.svg" width="20px" alt="" />
              </a>
            </td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</section>

{{! edit data modal }}
<div
  class="modal fade"
  id="editBatch"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">Edit -
          {{batch.code}}</h5>
        <button
          type="button"
          class="btn-close"
          data-mdb-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form action="" id="eidtBatchForm">

          <div class="form-outline input-group-lg">
            <input
              type="number"
              id="seat_num"
              name="seat_num"
              class="form-control"
              required
              value="{{batch.seat_num}}"
              min="{{batch.students}}"
            />
            <label class="form-label" for="seat_num">Number of Seats</label>
          </div>
          <div class="input-group-lg mt-3">
            <label class="form-label" for="batch_head">Batch Head</label>
            <select
              class="form-select form-control form-select-lg"
              name="batch_head"
              id="batch-head-select"
              required
            >
              <option
                selected
                value="{{batch.batch_head}}"
              >{{batch.head}}</option>
              {{#each openTeachers}}
                <option value="{{this.registerId}}">{{this.name}}</option>
              {{/each}}
            </select>
          </div>
          <p id="response"></p>
          <div class="mt-3 d-flex justify-content-end">
            <button
              type="submit"
              class="btn btn-outline-success"
            >Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>  
// Edit batch details
const form = document.getElementById("eidtBatchForm");
const code = document.getElementById("batch-code").innerText;
const res = document.getElementById("response");
const seat = document.getElementById("seat-num");
const head = document.getElementById("batch-head");
const headName = document.getElementById("batch-head-name");
const sel = document.getElementById("batch-head-select");

function formSubmit(e) {
  e.preventDefault();

  const formData = new FormData(form);
  const dataToSend = Object.fromEntries(formData);
  fetch(`http://localhost:5000/office/batch/edit-batch/${code}`, {
    method: "PUT",
    body: JSON.stringify(dataToSend),
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then((response) => response.json())
    .then((response) => {
      if (response.success) {
        res.classList.add("text-success");
        res.classList.remove("text-danger");
        seat.innerText = dataToSend.seat_num;
        head.innerText = `(${dataToSend.batch_head})`;
        const { text } = sel.options[sel.selectedIndex];
        headName.innerText = text;
      } else {
        res.classList.add("text-danger");
        res.classList.remove("text-success");
      }
      res.innerText = response.message;
    })
    .catch((error) => {
      res.classList.add("text-danger");
      res.classList.remove("text-success");
      res.innerText = "Somthing went wrong";
    });
}

form.addEventListener("submit", formSubmit);
</script>